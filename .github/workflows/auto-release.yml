name: Auto Release on Version Tag

on:
  push:
    tags:
      - 'v*'  # å½“æ¨é€ä»¥vå¼€å¤´çš„æ ‡ç­¾æ—¶è§¦å‘

permissions:
  contents: write  # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»ºrelease
  packages: write  # å¦‚æœéœ€è¦ä¸Šä¼ åŒ…

jobs:
  release:
    runs-on: macos-latest  # ä½¿ç”¨macOS runnerç¡®ä¿å…¼å®¹æ€§
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ç”¨äºç”Ÿæˆå‘å¸ƒè¯´æ˜
        
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller
        
    - name: Debug file structure
      run: |
        echo "ğŸ” æ£€æŸ¥é¡¹ç›®æ–‡ä»¶ç»“æ„..."
        pwd
        ls -la
        echo ""
        echo "ğŸ“ æ£€æŸ¥specæ–‡ä»¶..."
        if [ -f "PDFä¹¦ç­¾ç”Ÿæˆå™¨.spec" ]; then
          echo "âœ… æ‰¾åˆ°specæ–‡ä»¶: PDFä¹¦ç­¾ç”Ÿæˆå™¨.spec"
          ls -la "PDFä¹¦ç­¾ç”Ÿæˆå™¨.spec"
        else
          echo "âŒ æœªæ‰¾åˆ°specæ–‡ä»¶: PDFä¹¦ç­¾ç”Ÿæˆå™¨.spec"
          echo "ğŸ” æŸ¥æ‰¾æ‰€æœ‰.specæ–‡ä»¶..."
          find . -name "*.spec" -type f
        fi
        echo ""
        echo "ğŸ“ æ£€æŸ¥requirements.txt..."
        if [ -f "requirements.txt" ]; then
          echo "âœ… æ‰¾åˆ°requirements.txt"
          cat requirements.txt
        else
          echo "âŒ æœªæ‰¾åˆ°requirements.txt"
        fi
        
    - name: Build application
      run: |
        # ä½¿ç”¨æ‚¨çš„specæ–‡ä»¶æ„å»º
        echo "ğŸ”¨ å¼€å§‹æ„å»ºåº”ç”¨..."
        
        # æ£€æŸ¥specæ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "PDFä¹¦ç­¾ç”Ÿæˆå™¨.spec" ]; then
          echo "âŒ æ„å»ºå¤±è´¥ï¼šspecæ–‡ä»¶ä¸å­˜åœ¨"
          echo "å½“å‰ç›®å½•å†…å®¹ï¼š"
          ls -la
          exit 1
        fi
        
        # æ„å»ºåº”ç”¨
        pyinstaller "PDFä¹¦ç­¾ç”Ÿæˆå™¨.spec"
        
        # éªŒè¯æ„å»ºç»“æœ
        if [ ! -d "dist/PDFä¹¦ç­¾ç”Ÿæˆå™¨.app" ]; then
          echo "âŒ æ„å»ºå¤±è´¥ï¼šæœªæ‰¾åˆ°åº”ç”¨æ–‡ä»¶"
          echo "distç›®å½•å†…å®¹ï¼š"
          ls -la dist/ || echo "distç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "âœ… åº”ç”¨æ„å»ºæˆåŠŸ"
        ls -la dist/
        
    - name: Create release zip
      run: |
        echo "ğŸ“¦ åˆ›å»ºå‘å¸ƒzipæ–‡ä»¶..."
        cd dist
        zip -r "PDFä¹¦ç­¾ç”Ÿæˆå™¨_${GITHUB_REF_NAME}_macOS.zip" "PDFä¹¦ç­¾ç”Ÿæˆå™¨.app"
        
        # éªŒè¯zipæ–‡ä»¶
        if [ ! -f "PDFä¹¦ç­¾ç”Ÿæˆå™¨_${GITHUB_REF_NAME}_macOS.zip" ]; then
          echo "âŒ zipæ–‡ä»¶åˆ›å»ºå¤±è´¥"
          exit 1
        fi
        
        echo "âœ… zipæ–‡ä»¶åˆ›å»ºæˆåŠŸ"
        ls -la "PDFä¹¦ç­¾ç”Ÿæˆå™¨_${GITHUB_REF_NAME}_macOS.zip"
        
        # è¿”å›é¡¹ç›®æ ¹ç›®å½•
        cd ..
        
    - name: Get release notes
      id: get_release_notes
      run: |
        echo "ğŸ” æŸ¥æ‰¾å‘å¸ƒè¯´æ˜æ–‡ä»¶..."
        echo "ç‰ˆæœ¬: ${GITHUB_REF_NAME}"
        echo "æŸ¥æ‰¾æ–‡ä»¶: docs/releases/RELEASE_NOTES_${GITHUB_REF_NAME}.md"
        
        if [ -f "docs/releases/RELEASE_NOTES_${GITHUB_REF_NAME}.md" ]; then
          echo "âœ… æ‰¾åˆ°å‘å¸ƒè¯´æ˜æ–‡ä»¶"
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          cat "docs/releases/RELEASE_NOTES_${GITHUB_REF_NAME}.md" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "ğŸ“‹ ä½¿ç”¨å‘å¸ƒè¯´æ˜æ–‡ä»¶: docs/releases/RELEASE_NOTES_${GITHUB_REF_NAME}.md"
        else
          echo "âš ï¸ æœªæ‰¾åˆ°å‘å¸ƒè¯´æ˜æ–‡ä»¶ï¼Œä½¿ç”¨é»˜è®¤è¯´æ˜"
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_OUTPUT
          echo "# PDFä¹¦ç­¾ç”Ÿæˆå™¨ ${GITHUB_REF_NAME} å‘å¸ƒè¯´æ˜" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## ğŸ‰ æ–°ç‰ˆæœ¬å‘å¸ƒ" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "**ç‰ˆæœ¬**: ${GITHUB_REF_NAME}" >> $GITHUB_OUTPUT
          echo "**å‘å¸ƒæ—¥æœŸ**: $(date +"%Yå¹´%mæœˆ%dæ—¥")" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## ğŸ“ æœ€æ–°æäº¤ä¿¡æ¯" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "**æœ€åæäº¤**: \`$(git log -1 --pretty=format:'%h')\`" >> $GITHUB_OUTPUT
          echo "**æäº¤æ—¶é—´**: $(git log -1 --pretty=format:'%cd' --date=format:'%Yå¹´%mæœˆ%dæ—¥ %H:%M:%S')" >> $GITHUB_OUTPUT
          echo "**æäº¤è€…**: $(git log -1 --pretty=format:'%an')" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "**æäº¤æ¶ˆæ¯**:">> $GITHUB_OUTPUT
          echo "\`\`\`" >> $GITHUB_OUTPUT
          git log -1 --pretty=format:'%B' >> $GITHUB_OUTPUT
          echo "\`\`\`" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "## âš ï¸ é‡è¦è¯´æ˜" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
          echo "### ğŸ”’ macOSå®‰å…¨é™åˆ¶" >> $GITHUB_OUTPUT
          echo "ç”±äºmacOS Gatekeeperå®‰å…¨æœºåˆ¶ï¼Œä¸‹è½½çš„åº”ç”¨å¯èƒ½æ— æ³•ç›´æ¥è¿è¡Œã€‚" >> $GITHUB_OUTPUT
          echo "" >> $GITHUB_OUTPUT
                          echo "**è§£å†³æ–¹æ³•**: " >> $GITHUB_OUTPUT
                          echo "1. å³é”®ç‚¹å‡»åº”ç”¨ â†’ é€‰æ‹©'æ‰“å¼€'" >> $GITHUB_OUTPUT
                          echo "2. æˆ–åœ¨ç³»ç»Ÿåå¥½è®¾ç½® > å®‰å…¨æ€§ä¸éšç§ä¸­å…è®¸è¿è¡Œ" >> $GITHUB_OUTPUT
                          echo "3. æˆ–ä½¿ç”¨æœ¬åœ°æ„å»ºè„šæœ¬ï¼ˆæ¨èï¼‰" >> $GITHUB_OUTPUT
                          echo "" >> $GITHUB_OUTPUT
                          echo "### ğŸ  æœ¬åœ°æ„å»ºï¼ˆæ¨èï¼‰" >> $GITHUB_OUTPUT
                          echo "```bash" >> $GITHUB_OUTPUT
                          echo "# å…‹éš†ä»“åº“" >> $GITHUB_OUTPUT
                          echo "git clone https://github.com/vanabel/pdf-bookmarker.git" >> $GITHUB_OUTPUT
                          echo "cd pdf-bookmarker" >> $GITHUB_OUTPUT
                          echo "" >> $GITHUB_OUTPUT
                          echo "# è¿è¡Œæ„å»ºè„šæœ¬" >> $GITHUB_OUTPUT
                          echo "./build_macos_optimized.sh" >> $GITHUB_OUTPUT
                          echo "```" >> $GITHUB_OUTPUT
                          echo "" >> $GITHUB_OUTPUT
                          echo "æœ¬åœ°æ„å»ºå°†è‡ªåŠ¨å¤„ç†æ‰€æœ‰å…¼å®¹æ€§é—®é¢˜ï¼" >> $GITHUB_OUTPUT
                          echo "EOF" >> $GITHUB_OUTPUT
        fi
        
    - name: Create Release
      id: create_release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: PDFä¹¦ç­¾ç”Ÿæˆå™¨ ${{ github.ref_name }}
        body: ${{ steps.get_release_notes.outputs.RELEASE_NOTES }}
        draft: false
        prerelease: false
        files: dist/PDFä¹¦ç­¾ç”Ÿæˆå™¨_${{ github.ref_name }}_macOS.zip
        
    - name: Verify upload
      run: |
        echo "ğŸ” éªŒè¯ä¸Šä¼ ç»“æœ..."
        echo "Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
        echo "ä¸Šä¼ çš„zipæ–‡ä»¶: PDFä¹¦ç­¾ç”Ÿæˆå™¨_${{ github.ref_name }}_macOS.zip"
        
    - name: Cleanup build files
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
        rm -rf build dist __pycache__
        find . -name "*.pyc" -delete
        echo "âœ… æ¸…ç†å®Œæˆ"
